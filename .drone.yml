kind: pipeline
type: docker
name: default

trigger:
  event:
    - push

steps:
  
  - name: build
    image: node:20 #voir pour changer la version ?    
    commands:
      - cd cryptide_project
      - npm install --legacy-peer-deps
      - CI=false npm run build
  
  - name: sonar-analyses
    image: node:20
    commands:
      - cd ./cryptide_project
      #- npm install --legacy-peer-deps
      - npm run test
      - ls ./test/coverage
      - sonar-scanner -Dsonar.projectKey=Learnihon -Dsonar.sources=. -Dsonar.host.url=$${PLUGIN_SONAR_HOST}
        -Dsonar.login=$${PLUGIN_SONAR_TOKEN} -Dsonar.javascript.lcov.reportPaths=./test/coverage/lcov.info 
        -Dsonar.exclusions=**/lcov-report/**
    secrets: [ SECRET_SONAR_LOGIN_CRYPTIDE ]
    settings:
      sonar_host: https://codefirst.iut.uca.fr/sonar/
      sonar_token:
        from_secret: SECRET_SONAR_LOGIN_CRYPTIDE
    when:
      event:
        - push
        - push_request